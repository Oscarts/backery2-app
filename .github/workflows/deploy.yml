# CI/CD Pipeline for RapidPro Bakery App
# Triggers on push to main branch
# Runs tests, builds, and deploys to production

name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20.x'

jobs:
  # ============================================
  # Job 1: Lint and Type Check
  # ============================================
  lint:
    name: ğŸ” Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Type check backend
        run: cd backend && npx tsc --noEmit

      - name: ğŸ” Type check frontend
        run: cd frontend && npx tsc --noEmit

  # ============================================
  # Job 2: Run Tests
  # ============================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: cd backend && npx prisma generate

      - name: ğŸ§ª Run backend tests
        run: cd backend && npm test -- --passWithNoTests
        
      - name: ğŸ§ª Run frontend tests
        run: cd frontend && npm test -- --passWithNoTests

  # ============================================
  # Job 3: Build
  # ============================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: cd backend && npx prisma generate

      - name: ğŸ—ï¸ Build backend
        run: cd backend && npm run build

      - name: ğŸ—ï¸ Build frontend
        run: cd frontend && npm run build
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL || 'https://rapidpro-api.onrender.com' }}

      - name: ğŸ“¤ Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  # ============================================
  # Job 4: Deploy (only on main branch push)
  # ============================================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”” Trigger Render Deploy
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
            echo "âœ… Render deployment triggered"
          else
            echo "âš ï¸ RENDER_DEPLOY_HOOK_URL not set, skipping Render deploy"
          fi

      - name: âœ… Deployment initiated
        run: |
          echo "ğŸš€ Deployment pipeline completed!"
          echo ""
          echo "ğŸ“± Frontend: Vercel auto-deploys from GitHub"
          echo "ğŸ–¥ï¸ Backend: Render deploy hook triggered"
          echo ""
          echo "Check deployment status:"
          echo "- Vercel: https://vercel.com/dashboard"
          echo "- Render: https://dashboard.render.com"
