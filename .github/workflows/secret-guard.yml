name: Prevent secrets in repo

on:
  pull_request:

jobs:
  check-secrets:
    name: Fail on committed secrets or generateValue
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for committed JWT_SECRET values or generateValue
        run: |
          set -euo pipefail
          echo "Checking repository for committed JWT_SECRET values and generateValue: true..."
          # Use grep across repo to detect problematic patterns
          if grep -RIn --exclude-dir=.git --exclude-dir=node_modules -E "JWT_SECRET.*value:|generateValue:\s*true|JWT_SECRET\s*=|JWT_SECRET:\s*'" . ; then
            echo "ERROR: Found committed JWT_SECRET value or generateValue: true; remove it from the PR or move secret to the platform's secret store."
            exit 1
          fi

      - name: Success
        run: echo "No committed JWT secrets or generateValue: true found in repository."
