generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT AUTHENTICATION & AUTHORIZATION
// ============================================

model Client {
  id          String   @id @default(cuid())
  name        String   @unique // Company/bakery name
  slug        String   @unique // URL-friendly identifier
  email       String?
  phone       String?
  address     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Subscription & Billing
  subscriptionPlan    SubscriptionPlan   @default(TRIAL)
  maxUsers            Int                @default(5) // User limit based on plan
  billingEmail        String?
  subscriptionStatus  SubscriptionStatus @default(TRIAL)
  trialEndsAt         DateTime?
  subscriptionEndsAt  DateTime?
  stripeCustomerId    String?
  stripeSubscriptionId String?
  
  // Relations
  users               User[]
  roles               Role[]
  
  // All data belongs to a client (tenant isolation)
  rawMaterials        RawMaterial[]
  finishedProducts    FinishedProduct[]
  recipes             Recipe[]
  productionRuns      ProductionRun[]
  customers           Customer[]
  customerOrders      CustomerOrder[]
  categories          Category[]
  suppliers           Supplier[]
  storageLocations    StorageLocation[]
  qualityStatuses     QualityStatus[]
  skuMappings         SkuMapping[]
  
  @@map("clients")
}

model Role {
  id          String   @id @default(cuid())
  name        String   // e.g., "Admin", "Inventory Manager", "Sales Manager"
  description String?
  isSystem    Boolean  @default(false) // True for ADMIN role (cannot be deleted)
  clientId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  users       User[]
  permissions RolePermission[]
  
  @@unique([clientId, name])
  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  resource    String   // Page/module identifier (e.g., "raw-materials", "customer-orders")
  action      String   // "view", "create", "edit", "delete"
  description String?
  createdAt   DateTime @default(now())
  
  rolePermissions RolePermission[]
  
  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(CUSTOM)  // Legacy: ADMIN/MANAGER/STAFF/VIEWER/CUSTOM
  roleId       String?  // New: Reference to custom Role table
  clientId     String   // Multi-tenant isolation
  firstName    String
  lastName     String
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  customRole   Role?    @relation(fields: [roleId], references: [id], onDelete: SetNull)
  
  @@index([clientId])
  @@index([email])
  @@map("users")
}

model Category {
  id                   String                @id @default(cuid())
  name                 String
  type                 CategoryType
  description          String?
  clientId             String                // Multi-tenant isolation
  createdAt            DateTime              @default(now())
  finishedProducts     FinishedProduct[]
  // intermediateProducts removed
  rawMaterials         RawMaterial[]
  recipes              Recipe[]
  
  client               Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, name])  // Categories unique per client
  @@index([clientId])
  @@map("categories")
}

model Supplier {
  id           String        @id @default(cuid())
  name         String
  contactInfo  Json?
  address      String?
  isActive     Boolean       @default(true)
  clientId     String        // Multi-tenant isolation
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  rawMaterials RawMaterial[]
  
  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, name])  // Suppliers unique per client
  @@index([clientId])
  @@map("suppliers")
}

model StorageLocation {
  id                   String                @id @default(cuid())
  name                 String
  type                 String?
  description          String?
  capacity             String?
  clientId             String                // Multi-tenant isolation
  createdAt            DateTime              @default(now())
  finishedProducts     FinishedProduct[]
  // intermediateProducts removed
  rawMaterials         RawMaterial[]
  
  client               Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, name])  // Storage locations unique per client
  @@index([clientId])
  @@map("storage_locations")
}

model QualityStatus {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  color                String?               // For UI display
  isActive             Boolean               @default(true)
  sortOrder            Int                   @default(0)
  clientId             String                // Multi-tenant isolation
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  rawMaterials         RawMaterial[]
  // intermediateProducts removed
  finishedProducts     FinishedProduct[]
  
  client               Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, name])  // Quality statuses unique per client
  @@index([clientId])
  @@map("quality_statuses")
}

model Unit {
  id          String   @id @default(cuid())
  name        String   @unique
  symbol      String   @unique
  category    String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("units")
}

model SkuMapping {
  id          String   @id @default(cuid())
  name        String   // Product/material name (unique per client)
  sku         String   // Auto-generated or manually set SKU
  description String?
  category    String?  // General category hint
  clientId    String   // Multi-tenant isolation
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, clientId]) // Name must be unique per client
  @@unique([sku, clientId])  // SKU must be unique per client
  @@index([name])
  @@index([sku])
  @@index([clientId])
  @@map("sku_mappings")
}

model RawMaterial {
  id                String             @id @default(cuid())
  name              String
  // Shared SKU logic: materials with the same name share the same SKU as finished products
  sku               String?
  description       String?
  categoryId        String?
  supplierId        String
  batchNumber       String             // Format: SUPPLIER_CODE-YYYYMMDD-SEQ (e.g., SUP1-20251101-001)
  purchaseDate      DateTime?
  expirationDate    DateTime
  quantity          Float
  unit              String
  unitPrice         Float
  reorderLevel      Float              @default(0) // Default to 0 for optional
  reservedQuantity  Float              @default(0) @map("reserved_quantity")
  storageLocationId String
  qualityStatusId   String?
  isContaminated    Boolean            @default(false)
  clientId          String             // Multi-tenant isolation
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  category          Category?          @relation(fields: [categoryId], references: [id])
  storageLocation   StorageLocation    @relation(fields: [storageLocationId], references: [id])
  supplier          Supplier           @relation(fields: [supplierId], references: [id])
  qualityStatus     QualityStatus?     @relation(fields: [qualityStatusId], references: [id])
  client            Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  recipeIngredients RecipeIngredient[]

  @@index([clientId])
  @@index([name])
  @@index([sku])
  @@index([batchNumber])
  @@index([supplierId])
  @@index([expirationDate])
  @@map("raw_materials")
}


model FinishedProduct {
  id                String           @id @default(cuid())
  name              String
  description       String?
  sku               String           // No longer unique: multiple batches of same product share SKU
  categoryId        String?
  batchNumber       String
  productionDate    DateTime
  expirationDate    DateTime
  shelfLife         Int
  quantity          Float
  reservedQuantity  Float            @default(0)
  unit              String
  salePrice         Float
  costToProduce     Float?
  markupPercentage  Float?           @default(50) // Profit margin percentage
  packagingInfo     String?
  storageLocationId String?
  qualityStatusId   String?
  productionRunId   String?          @map("production_run_id")
  status            ProductionStatus @default(IN_PROGRESS)
  isContaminated    Boolean          @default(false)
  clientId          String           // Multi-tenant isolation
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  category          Category?        @relation(fields: [categoryId], references: [id])
  storageLocation   StorageLocation? @relation(fields: [storageLocationId], references: [id])
  qualityStatus     QualityStatus?   @relation(fields: [qualityStatusId], references: [id])
  productionRun     ProductionRun?   @relation(fields: [productionRunId], references: [id])
  client            Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  recipeIngredients RecipeIngredient[]

  @@index([clientId])
  @@map("finished_products")
}

model Recipe {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  categoryId           String?
  yieldQuantity        Float
  yieldUnit            String
  prepTime             Int?
  cookTime             Int?
  instructions         Json?
  version              Int                   @default(1)
  isActive             Boolean               @default(true)
  
  // Production-specific fields
  emoji                String?
  difficulty           RecipeDifficulty?     @default(MEDIUM)
  estimatedTotalTime   Int?                  // minutes
  estimatedCost        Float?                // Estimated cost to produce
  equipmentRequired    String[]              @default([])
  
  // UI Enhancement fields
  imageUrl             String?               @map("image_url")
  overheadPercentage   Float?                @default(20) @map("overhead_percentage")
  
  clientId             String                // Multi-tenant isolation
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
    // intermediateProducts removed
  category             Category?             @relation(fields: [categoryId], references: [id])
  client               Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  ingredients          RecipeIngredient[]
  productionRuns       ProductionRun[]

  @@index([clientId])
  @@map("recipes")
}

model RecipeIngredient {
  id                    String               @id @default(cuid())
  recipeId              String
  rawMaterialId         String?
    finishedProductId    String?
  quantity              Float
  unit                  String
  notes                 String?
  createdAt             DateTime             @default(now())
  recipe                Recipe               @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  rawMaterial           RawMaterial?         @relation(fields: [rawMaterialId], references: [id])
    finishedProduct      FinishedProduct?     @relation(fields: [finishedProductId], references: [id])

  @@map("recipe_ingredients")
}

model ProductionRun {
  id                String              @id @default(cuid())
  name              String
  recipeId          String
  targetQuantity    Float
  targetUnit        String
  status            ProductionStatus    @default(PLANNED)
  currentStepIndex  Int                 @default(0)
  startedAt         DateTime            @default(now())
  completedAt       DateTime?
  estimatedFinish   DateTime?
  actualCost        Float?
  finalQuantity     Float?
  notes             String?
  clientId          String              // Multi-tenant isolation
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  recipe            Recipe              @relation(fields: [recipeId], references: [id])
  client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  steps             ProductionStep[]
  allocations       ProductionAllocation[]
  finishedProducts  FinishedProduct[]

  @@index([clientId])
  @@map("production_runs")
}

model ProductionStep {
  id                String              @id @default(cuid())
  productionRunId   String
  name              String
  description       String?
  stepOrder         Int
  estimatedMinutes  Int?
  status            ProductionStepStatus @default(PENDING)
  startedAt         DateTime?
  completedAt       DateTime?
  actualMinutes     Int?
  notes             String?
  temperature       Int?                // Fahrenheit
  equipmentUsed     String[]            @default([])
  qualityCheckPassed Boolean?
  qualityCheckData  Json?               // Quality checkpoint details
  resourcesConsumed Json?               // Materials consumed in this step
  yieldQuantity     Float?              // Actual output from this step
  yieldUnit         String?             // Unit for yield
  efficiencyScore   Float?              // Planned vs actual time efficiency
  alertsGenerated   String[]            @default([]) // Any alerts during step
  stepPhotos        String[]            @default([]) // Photo documentation
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  productionRun     ProductionRun       @relation(fields: [productionRunId], references: [id], onDelete: Cascade)

  @@map("production_steps")
}

model ProductionAllocation {
  id                String              @id @default(cuid())
  productionRunId   String              @map("production_run_id")
  materialType      String              @map("material_type")
  materialId        String              @map("material_id")
  materialName      String              @map("material_name")
  materialSku       String?             @map("material_sku")
  materialBatchNumber String?           @map("material_batch_number")
  quantityAllocated Float               @map("quantity_allocated")
  quantityReleased  Float?              @map("quantity_released")
  quantityConsumed  Float?              @map("quantity_consumed")
  unit              String
  unitCost          Float?              @map("unit_cost")
  totalCost         Float?              @map("total_cost")
  status            String              @default("ALLOCATED")
  notes             String?
  allocatedAt       DateTime            @default(now()) @map("allocated_at")
  consumedAt        DateTime?           @map("consumed_at")
  releasedAt        DateTime?           @map("released_at")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  
  productionRun     ProductionRun       @relation(fields: [productionRunId], references: [id], onDelete: Cascade)

  @@map("production_allocations")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  VIEWER
  CUSTOM  // For users with custom role assignments
}

enum CategoryType {
  RAW_MATERIAL
  // INTERMEDIATE removed
  FINISHED_PRODUCT
  RECIPE
}

// IntermediateProductStatus enum removed

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum ProductionStepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  FULFILLED
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  clientId  String   // Multi-tenant isolation
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    CustomerOrder[]
  
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("customers")
}

model CustomerOrder {
  id                      String      @id @default(cuid())
  orderNumber             String      @unique
  customerId              String      @map("customer_id")
  expectedDeliveryDate    DateTime    @map("expected_delivery_date")
  status                  OrderStatus @default(DRAFT)
  totalProductionCost     Float       @default(0) @map("total_production_cost")
  totalPrice              Float       @default(0) @map("total_price")
  priceMarkupPercentage   Float       @default(30) @map("price_markup_percentage")
  tvaRate                 Float       @default(20) @map("tva_rate") // TVA/VAT rate in percentage (default 20% for France)
  notes                   String?
  clientId                String      // Multi-tenant isolation
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @updatedAt @map("updated_at")
  
  customer                Customer    @relation(fields: [customerId], references: [id])
  client                  Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items                   OrderItem[]

  @@index([clientId])
  @@index([customerId])
  @@index([status])
  @@index([expectedDeliveryDate])
  @@map("customer_orders")
}

model OrderItem {
  id                  String        @id @default(cuid())
  orderId             String        @map("order_id")
  productId           String        @map("product_id")
  productName         String        @map("product_name")
  productSku          String?       @map("product_sku")
  quantity            Int
  unitProductionCost  Float         @map("unit_production_cost")
  unitPrice           Float         @map("unit_price")
  lineProductionCost  Float         @map("line_production_cost")
  linePrice           Float         @map("line_price")
  createdAt           DateTime      @default(now()) @map("created_at")
  
  order               CustomerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_items")
}

// ============================================
// SUBSCRIPTION & BILLING ENUMS
// ============================================

enum SubscriptionPlan {
  TRIAL       // Free trial period
  FREE        // Free forever (limited features)
  STARTER     // €50/month - up to 5 users
  PROFESSIONAL // €150/month - up to 20 users
  ENTERPRISE  // Custom pricing - unlimited users
}

enum SubscriptionStatus {
  TRIAL       // In trial period
  ACTIVE      // Subscription active and paid
  PAST_DUE    // Payment failed, grace period
  CANCELED    // User canceled
  SUSPENDED   // Admin suspended
}
