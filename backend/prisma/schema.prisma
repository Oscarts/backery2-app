generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(STAFF)
  firstName    String
  lastName     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

model Category {
  id                   String                @id @default(cuid())
  name                 String
  type                 CategoryType
  description          String?
  createdAt            DateTime              @default(now())
  finishedProducts     FinishedProduct[]
  intermediateProducts IntermediateProduct[]
  rawMaterials         RawMaterial[]
  recipes              Recipe[]

  @@map("categories")
}

model Supplier {
  id           String        @id @default(cuid())
  name         String
  contactInfo  Json?
  address      String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  rawMaterials RawMaterial[]

  @@map("suppliers")
}

model StorageLocation {
  id                   String                @id @default(cuid())
  name                 String
  type                 String?
  description          String?
  capacity             String?
  createdAt            DateTime              @default(now())
  finishedProducts     FinishedProduct[]
  intermediateProducts IntermediateProduct[]
  rawMaterials         RawMaterial[]

  @@map("storage_locations")
}

model QualityStatus {
  id                   String                @id @default(cuid())
  name                 String                @unique
  description          String?
  color                String?               // For UI display
  isActive             Boolean               @default(true)
  sortOrder            Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  rawMaterials         RawMaterial[]
  intermediateProducts IntermediateProduct[]
  finishedProducts     FinishedProduct[]

  @@map("quality_statuses")
}

model Unit {
  id          String   @id @default(cuid())
  name        String   @unique
  symbol      String   @unique
  category    String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("units")
}

model RawMaterial {
  id                String             @id @default(cuid())
  name              String
  description       String?
  categoryId        String
  supplierId        String
  batchNumber       String
  purchaseDate      DateTime?
  expirationDate    DateTime
  quantity          Float
  unit              String
  unitPrice         Float
  reorderLevel      Float
  storageLocationId String
  qualityStatusId   String?
  isContaminated    Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  category          Category           @relation(fields: [categoryId], references: [id])
  storageLocation   StorageLocation    @relation(fields: [storageLocationId], references: [id])
  supplier          Supplier           @relation(fields: [supplierId], references: [id])
  qualityStatus     QualityStatus?     @relation(fields: [qualityStatusId], references: [id])
  recipeIngredients RecipeIngredient[]

  @@map("raw_materials")
}

model IntermediateProduct {
  id                String                    @id @default(cuid())
  name              String
  description       String
  categoryId        String
  batchNumber       String                    @unique
  productionDate    DateTime
  expirationDate    DateTime
  quantity          Float
  unit              String
  storageLocationId String
  status            IntermediateProductStatus @default(IN_PRODUCTION)
  contaminated      Boolean                   @default(false)
  qualityStatusId   String?
  recipeId          String?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  category          Category                  @relation(fields: [categoryId], references: [id])
  recipe            Recipe?                   @relation(fields: [recipeId], references: [id])
  storageLocation   StorageLocation           @relation(fields: [storageLocationId], references: [id])
  qualityStatus     QualityStatus?            @relation(fields: [qualityStatusId], references: [id])
  recipeIngredients RecipeIngredient[]

  @@map("intermediate_products")
}

model FinishedProduct {
  id                String           @id @default(cuid())
  name              String
  description       String?
  sku               String           @unique
  categoryId        String
  batchNumber       String
  productionDate    DateTime
  expirationDate    DateTime
  shelfLife         Int
  quantity          Float
  reservedQuantity  Float            @default(0)
  unit              String
  salePrice         Float
  costToProduce     Float?
  packagingInfo     String?
  storageLocationId String?
  qualityStatusId   String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  category          Category         @relation(fields: [categoryId], references: [id])
  storageLocation   StorageLocation? @relation(fields: [storageLocationId], references: [id])
  qualityStatus     QualityStatus?   @relation(fields: [qualityStatusId], references: [id])

  @@map("finished_products")
}

model Recipe {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  categoryId           String
  yieldQuantity        Float
  yieldUnit            String
  prepTime             Int?
  cookTime             Int?
  instructions         Json?
  version              Int                   @default(1)
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  intermediateProducts IntermediateProduct[]
  category             Category              @relation(fields: [categoryId], references: [id])
  ingredients          RecipeIngredient[]

  @@map("recipes")
}

model RecipeIngredient {
  id                    String               @id @default(cuid())
  recipeId              String
  rawMaterialId         String?
  intermediateProductId String?
  quantity              Float
  unit                  String
  notes                 String?
  createdAt             DateTime             @default(now())
  recipe                Recipe               @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  rawMaterial           RawMaterial?         @relation(fields: [rawMaterialId], references: [id])
  intermediateProduct   IntermediateProduct? @relation(fields: [intermediateProductId], references: [id])

  @@map("recipe_ingredients")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  VIEWER
}

enum CategoryType {
  RAW_MATERIAL
  INTERMEDIATE
  FINISHED_PRODUCT
  RECIPE
}

enum IntermediateProductStatus {
  IN_PRODUCTION
  COMPLETED
  ON_HOLD
  DISCARDED
}
