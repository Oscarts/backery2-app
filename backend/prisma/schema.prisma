generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(STAFF)
  firstName    String
  lastName     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

model Category {
  id                   String                @id @default(cuid())
  name                 String                @unique
  type                 CategoryType
  description          String?
  createdAt            DateTime              @default(now())
  finishedProducts     FinishedProduct[]
  // intermediateProducts removed
  rawMaterials         RawMaterial[]
  recipes              Recipe[]

  @@map("categories")
}

model Supplier {
  id           String        @id @default(cuid())
  name         String        @unique
  contactInfo  Json?
  address      String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  rawMaterials RawMaterial[]

  @@map("suppliers")
}

model StorageLocation {
  id                   String                @id @default(cuid())
  name                 String                @unique
  type                 String?
  description          String?
  capacity             String?
  createdAt            DateTime              @default(now())
  finishedProducts     FinishedProduct[]
  // intermediateProducts removed
  rawMaterials         RawMaterial[]

  @@map("storage_locations")
}

model QualityStatus {
  id                   String                @id @default(cuid())
  name                 String                @unique
  description          String?
  color                String?               // For UI display
  isActive             Boolean               @default(true)
  sortOrder            Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  rawMaterials         RawMaterial[]
  // intermediateProducts removed
  finishedProducts     FinishedProduct[]

  @@map("quality_statuses")
}

model Unit {
  id          String   @id @default(cuid())
  name        String   @unique
  symbol      String   @unique
  category    String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("units")
}

model SkuMapping {
  id          String   @id @default(cuid())
  name        String   @unique // Product/material name (unique across system)
  sku         String   @unique // Auto-generated or manually set SKU
  description String?
  category    String?  // General category hint
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([sku])
  @@map("sku_mappings")
}

model RawMaterial {
  id                String             @id @default(cuid())
  name              String
  // Shared SKU logic: materials with the same name share the same SKU as finished products
  sku               String?
  description       String?
  categoryId        String?
  supplierId        String
  batchNumber       String             // Format: SUPPLIER_CODE-YYYYMMDD-SEQ (e.g., SUP1-20251101-001)
  purchaseDate      DateTime?
  expirationDate    DateTime
  quantity          Float
  unit              String
  unitPrice         Float
  reorderLevel      Float              @default(0) // Default to 0 for optional
  reservedQuantity  Float              @default(0) @map("reserved_quantity")
  storageLocationId String
  qualityStatusId   String?
  isContaminated    Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  category          Category?          @relation(fields: [categoryId], references: [id])
  storageLocation   StorageLocation    @relation(fields: [storageLocationId], references: [id])
  supplier          Supplier           @relation(fields: [supplierId], references: [id])
  qualityStatus     QualityStatus?     @relation(fields: [qualityStatusId], references: [id])
  recipeIngredients RecipeIngredient[]

  @@index([name])
  @@index([sku])
  @@index([batchNumber])
  @@index([supplierId])
  @@index([expirationDate])
  @@map("raw_materials")
}


model FinishedProduct {
  id                String           @id @default(cuid())
  name              String
  description       String?
  sku               String           // No longer unique: multiple batches of same product share SKU
  categoryId        String?
  batchNumber       String
  productionDate    DateTime
  expirationDate    DateTime
  shelfLife         Int
  quantity          Float
  reservedQuantity  Float            @default(0)
  unit              String
  salePrice         Float
  costToProduce     Float?
  markupPercentage  Float?           @default(50) // Profit margin percentage
  packagingInfo     String?
  storageLocationId String?
  qualityStatusId   String?
  productionRunId   String?          @map("production_run_id")
  status            ProductionStatus @default(IN_PROGRESS)
  isContaminated    Boolean          @default(false)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  category          Category?        @relation(fields: [categoryId], references: [id])
  storageLocation   StorageLocation? @relation(fields: [storageLocationId], references: [id])
  qualityStatus     QualityStatus?   @relation(fields: [qualityStatusId], references: [id])
  productionRun     ProductionRun?   @relation(fields: [productionRunId], references: [id])
  recipeIngredients RecipeIngredient[]

  @@map("finished_products")
}

model Recipe {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  categoryId           String?
  yieldQuantity        Float
  yieldUnit            String
  prepTime             Int?
  cookTime             Int?
  instructions         Json?
  version              Int                   @default(1)
  isActive             Boolean               @default(true)
  
  // Production-specific fields
  emoji                String?
  difficulty           RecipeDifficulty?     @default(MEDIUM)
  estimatedTotalTime   Int?                  // minutes
  estimatedCost        Float?                // Estimated cost to produce
  equipmentRequired    String[]              @default([])
  
  // UI Enhancement fields
  imageUrl             String?               @map("image_url")
  overheadPercentage   Float?                @default(20) @map("overhead_percentage")
  
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
    // intermediateProducts removed
  category             Category?             @relation(fields: [categoryId], references: [id])
  ingredients          RecipeIngredient[]
  productionRuns       ProductionRun[]

  @@map("recipes")
}

model RecipeIngredient {
  id                    String               @id @default(cuid())
  recipeId              String
  rawMaterialId         String?
    finishedProductId    String?
  quantity              Float
  unit                  String
  notes                 String?
  createdAt             DateTime             @default(now())
  recipe                Recipe               @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  rawMaterial           RawMaterial?         @relation(fields: [rawMaterialId], references: [id])
    finishedProduct      FinishedProduct?     @relation(fields: [finishedProductId], references: [id])

  @@map("recipe_ingredients")
}

model ProductionRun {
  id                String              @id @default(cuid())
  name              String
  recipeId          String
  targetQuantity    Float
  targetUnit        String
  status            ProductionStatus    @default(PLANNED)
  currentStepIndex  Int                 @default(0)
  startedAt         DateTime            @default(now())
  completedAt       DateTime?
  estimatedFinish   DateTime?
  actualCost        Float?
  finalQuantity     Float?
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  recipe            Recipe              @relation(fields: [recipeId], references: [id])
  steps             ProductionStep[]
  allocations       ProductionAllocation[]
  finishedProducts  FinishedProduct[]

  @@map("production_runs")
}

model ProductionStep {
  id                String              @id @default(cuid())
  productionRunId   String
  name              String
  description       String?
  stepOrder         Int
  estimatedMinutes  Int?
  status            ProductionStepStatus @default(PENDING)
  startedAt         DateTime?
  completedAt       DateTime?
  actualMinutes     Int?
  notes             String?
  temperature       Int?                // Fahrenheit
  equipmentUsed     String[]            @default([])
  qualityCheckPassed Boolean?
  qualityCheckData  Json?               // Quality checkpoint details
  resourcesConsumed Json?               // Materials consumed in this step
  yieldQuantity     Float?              // Actual output from this step
  yieldUnit         String?             // Unit for yield
  efficiencyScore   Float?              // Planned vs actual time efficiency
  alertsGenerated   String[]            @default([]) // Any alerts during step
  stepPhotos        String[]            @default([]) // Photo documentation
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  productionRun     ProductionRun       @relation(fields: [productionRunId], references: [id], onDelete: Cascade)

  @@map("production_steps")
}

model ProductionAllocation {
  id                String              @id @default(cuid())
  productionRunId   String              @map("production_run_id")
  materialType      String              @map("material_type")
  materialId        String              @map("material_id")
  materialName      String              @map("material_name")
  materialSku       String?             @map("material_sku")
  materialBatchNumber String?           @map("material_batch_number")
  quantityAllocated Float               @map("quantity_allocated")
  quantityReleased  Float?              @map("quantity_released")
  quantityConsumed  Float?              @map("quantity_consumed")
  unit              String
  unitCost          Float?              @map("unit_cost")
  totalCost         Float?              @map("total_cost")
  status            String              @default("ALLOCATED")
  notes             String?
  allocatedAt       DateTime            @default(now()) @map("allocated_at")
  consumedAt        DateTime?           @map("consumed_at")
  releasedAt        DateTime?           @map("released_at")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  
  productionRun     ProductionRun       @relation(fields: [productionRunId], references: [id], onDelete: Cascade)

  @@map("production_allocations")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  VIEWER
}

enum CategoryType {
  RAW_MATERIAL
  // INTERMEDIATE removed
  FINISHED_PRODUCT
  RECIPE
}

// IntermediateProductStatus enum removed

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum ProductionStepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  FULFILLED
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    CustomerOrder[]

  @@map("customers")
}

model CustomerOrder {
  id                      String      @id @default(cuid())
  orderNumber             String      @unique
  customerId              String      @map("customer_id")
  expectedDeliveryDate    DateTime    @map("expected_delivery_date")
  status                  OrderStatus @default(DRAFT)
  totalProductionCost     Float       @default(0) @map("total_production_cost")
  totalPrice              Float       @default(0) @map("total_price")
  priceMarkupPercentage   Float       @default(30) @map("price_markup_percentage")
  tvaRate                 Float       @default(20) @map("tva_rate") // TVA/VAT rate in percentage (default 20% for France)
  notes                   String?
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @updatedAt @map("updated_at")
  
  customer                Customer    @relation(fields: [customerId], references: [id])
  items                   OrderItem[]

  @@index([customerId])
  @@index([status])
  @@index([expectedDeliveryDate])
  @@map("customer_orders")
}

model OrderItem {
  id                  String        @id @default(cuid())
  orderId             String        @map("order_id")
  productId           String        @map("product_id")
  productName         String        @map("product_name")
  productSku          String?       @map("product_sku")
  quantity            Int
  unitProductionCost  Float         @map("unit_production_cost")
  unitPrice           Float         @map("unit_price")
  lineProductionCost  Float         @map("line_production_cost")
  linePrice           Float         @map("line_price")
  createdAt           DateTime      @default(now()) @map("created_at")
  
  order               CustomerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_items")
}
